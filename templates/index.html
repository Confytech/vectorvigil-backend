<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VectorVigil | Malaria Outbreak Prediction</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 400px; margin-top: 2rem; }
  </style>
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h2 class="text-center mb-4">VectorVigil: Malaria Risk Predictor</h2>
    <form id="predictForm" class="card p-4 shadow-sm">
      <div class="mb-3">
        <label for="rainfall" class="form-label">Rainfall (mm)</label>
        <input type="number" step="0.1" class="form-control" id="rainfall" required>
      </div>
      <div class="mb-3">
        <label for="temperature" class="form-label">Temperature (°C)</label>
        <input type="number" step="0.1" class="form-control" id="temperature" required>
      </div>
      <div class="mb-3">
        <label for="humidity" class="form-label">Humidity (%)</label>
        <input type="number" step="0.1" class="form-control" id="humidity" required>
      </div>
      <div class="mb-3">
        <label for="latitude" class="form-label">Latitude</label>
        <input type="number" step="0.0001" class="form-control" id="latitude" required>
      </div>
      <div class="mb-3">
        <label for="longitude" class="form-label">Longitude</label>
        <input type="number" step="0.0001" class="form-control" id="longitude" required>
      </div>
      <button type="submit" class="btn btn-primary">Predict</button>
    </form>

    <div class="alert mt-4 d-none" id="resultBox"></div>

    <!-- Outbreak Map -->
    <h4 class="mt-5">Outbreak Map</h4>
    <div id="map" class="rounded shadow-sm"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    document.getElementById('predictForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const rainfall = parseFloat(document.getElementById('rainfall').value);
      const temperature = parseFloat(document.getElementById('temperature').value);
      const humidity = parseFloat(document.getElementById('humidity').value);
      const latitude = parseFloat(document.getElementById('latitude').value);
      const longitude = parseFloat(document.getElementById('longitude').value);

      fetch('/predict', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ rainfall, temperature, humidity, latitude, longitude })
      })
      .then(response => response.json())
      .then(data => {
        const resultBox = document.getElementById('resultBox');
        if (data.risk === 1) {
          resultBox.className = "alert alert-danger";
          resultBox.textContent = "⚠️ High Risk of Malaria Outbreak!";
        } else if (data.risk === 0) {
          resultBox.className = "alert alert-success";
          resultBox.textContent = "✅ Low Risk of Malaria Outbreak.";
        } else {
          resultBox.className = "alert alert-warning";
          resultBox.textContent = "⚠️ Invalid response from server.";
        }
        resultBox.classList.remove("d-none");
        loadMapMarkers();  // Refresh markers on map
      })
      .catch(error => {
        const resultBox = document.getElementById('resultBox');
        resultBox.className = "alert alert-danger";
        resultBox.textContent = "❌ Error connecting to the backend.";
        resultBox.classList.remove("d-none");
      });
    });

    const map = L.map('map').setView([9.0820, 8.6753], 6); // Nigeria
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    function loadMapMarkers() {
      fetch('/map-data')
        .then(res => res.json())
        .then(points => {
          points.forEach(p => {
            const color = p.prediction === 1 ? 'red' : 'green';
            const marker = L.circleMarker([p.latitude, p.longitude], {
              radius: 8,
              fillColor: color,
              color: "#000",
              weight: 1,
              opacity: 1,
              fillOpacity: 0.8
            }).addTo(map);
            marker.bindPopup(`Risk: ${p.prediction === 1 ? 'High' : 'Low'}<br>Rainfall: ${p.rainfall}mm`);
          });
        });
    }

    // Load markers on page load
    loadMapMarkers();
  </script>
</body>
</html>

